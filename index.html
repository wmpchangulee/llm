<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LM Studio Pro - Full Capability Debugger</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root { --bg-color: #0f1117; --sidebar-bg: #1a1d27; --card-bg: #252936; --accent-color: #3b82f6; --highlight-color: #10b981; --reasoning-color: #f59e0b; --tool-color: #8b5cf6; --text-main: #e2e8f0; --text-muted: #94a3b8; --user-msg: #3b82f6; --ai-msg: #334155; }
    * { box-sizing: border-box; }
    body { font-family: 'Pretendard', sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; display: flex; height: 100vh; overflow: hidden; }
    #sidebar { width: 320px; background: var(--sidebar-bg); border-right: 1px solid #334155; display: flex; flex-direction: column; }
    .sidebar-section { padding: 20px; border-bottom: 1px solid #334155; }
    #chat-list-container { flex-grow: 1; overflow-y: auto; padding: 10px; }
    .chat-item { padding: 12px; border-radius: 8px; cursor: pointer; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; transition: 0.2s; font-size: 0.9rem; border: 1px solid transparent; }
    .chat-item.active { background: var(--card-bg); border-color: var(--accent-color); }
    .delete-chat { margin-left: auto; cursor: pointer; opacity: 0.3; }
    .delete-chat:hover { opacity: 1; color: #f87171; }
    .model-info-box { background: var(--card-bg); border-radius: 10px; padding: 12px; margin-top: 10px; border: 1px solid #334155; font-size: 0.85rem; line-height: 1.4; }
    
    /* 공통 배지 스타일 */
    .cap-badge { font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: bold; color: white; background: #444; text-transform: uppercase; }
    .badge-vis { background: var(--accent-color) !important; }
    .badge-rsn { background: var(--reasoning-color) !important; }
    .badge-tool { background: var(--tool-color) !important; }
    .badge-load { background: var(--highlight-color) !important; }

    #main-content { flex-grow: 1; display: flex; flex-direction: column; background: var(--bg-color); position: relative; }
    #chatBox { flex-grow: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
    .message { max-width: 85%; padding: 15px; border-radius: 12px; line-height: 1.6; word-break: break-word; }
    .user { align-self: flex-end; background: var(--user-msg); border-bottom-right-radius: 2px; color: white; }
    .assistant { align-self: flex-start; background: var(--ai-msg); border-bottom-left-radius: 2px; }
    .msg-image { max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 10px; display: block; }
    
    .reasoning-box { background: rgba(0, 0, 0, 0.2); border-left: 3px solid var(--reasoning-color); margin: 5px 0 15px 0; padding: 12px; border-radius: 4px; font-size: 0.9rem; color: var(--text-muted); }
    .reasoning-header { font-size: 0.75rem; font-weight: bold; color: var(--reasoning-color); margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }

    .input-area-wrapper { padding: 20px 40px; background: var(--bg-color); border-top: 1px solid #334155; }
    .input-area { display: flex; gap: 12px; align-items: flex-end; max-width: 1000px; margin: 0 auto; }
    #chatInput { flex-grow: 1; background: var(--card-bg); border: 1px solid #334155; color: white; padding: 12px; border-radius: 10px; outline: none; resize: none; min-height: 48px; max-height: 200px; font-family: inherit; }
    #image-preview-bar { display: none; padding: 10px; background: #1a1d27; border-radius: 10px; margin-bottom: 10px; position: relative; width: fit-content; border: 1px dashed var(--accent-color); }
    #image-preview-bar img { height: 80px; border-radius: 5px; }

    .btn { cursor: pointer; border: none; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .btn-send { background: var(--accent-color); color: white; width: 48px; height: 48px; flex-shrink: 0; }
    .btn-icon { background: var(--card-bg); color: var(--text-muted); width: 48px; height: 48px; border: 1px solid #334155; }
    .btn-icon:disabled { opacity: 0.2; cursor: not-allowed; }

    #modelModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index: 1000; justify-content:center; align-items:center; }
    .modal-content { background: var(--sidebar-bg); padding: 25px; border-radius: 15px; width: 500px; max-height: 80vh; overflow-y: auto; }
    .model-item { background: var(--card-bg); padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 2px solid transparent; cursor: pointer; position: relative; }
    .model-item.active { border-color: var(--highlight-color); }
    .badge-container { display: flex; gap: 5px; margin-top: 8px; flex-wrap: wrap; }
  </style>
</head>
<body>

<div id="sidebar">
  <div class="sidebar-section">
    <div style="font-size:0.7rem; color:var(--text-muted); font-weight:bold; letter-spacing:1px; margin-bottom:5px;">SYSTEM STATUS</div>
    <div id="active-model-info" class="model-info-box">연결 확인 중...</div>
    <button class="btn btn-send" style="width:100%; margin-top:10px; height:38px; font-size:0.8rem;" onclick="openModelModal()">모델 변경 (Unload/Load)</button>
  </div>
  <div id="chat-list-container">
    <button class="btn" style="width:calc(100% - 20px); background:#ffffff10; color:white; margin: 0 10px 15px 10px; padding:12px;" onclick="createNewChat()">+ New Chat</button>
    <div id="chat-list"></div>
  </div>
</div>

<div id="main-content">
  <div id="chatBox"></div>
  <div class="input-area-wrapper">
    <div id="image-preview-bar">
      <img id="img-preview-target" src="">
      <button onclick="clearSelectedImage()" style="position:absolute; top:-10px; right:-10px; background:#ef4444; color:white; border-radius:50%; width:24px; height:24px; border:none; cursor:pointer;">×</button>
    </div>
    <div class="input-area">
      <button id="imgBtn" class="btn btn-icon" onclick="document.getElementById('fileInput').click()" title="Vision 미지원"><i class="fas fa-image"></i></button>
      <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFileSelect(event)">
      <textarea id="chatInput" rows="1" placeholder="메시지 입력..."></textarea>
      <button id="sendBtn" class="btn btn-send" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<div id="modelModal"><div class="modal-content"><h3 style="margin-top:0;">모델 라이브러리</h3><div id="modal-model-list"></div><button class="btn btn-send" style="width:100%; margin-top:15px; height:40px;" onclick="closeModelModal()">닫기</button></div></div>

<script>
const BASE_URL = "https://nonconferrable-tactlessly-jenell.ngrok-free.dev";
let currentModel = null, isSending = false, selectedImageBase64 = null;
let chats = JSON.parse(localStorage.getItem('lm_chats') || '[]');
let currentChatId = localStorage.getItem('lm_current_chat_id');

marked.setOptions({ breaks: true, gfm: true, highlight: (code) => hljs.highlightAuto(code).value });

async function apiFetch(endpoint, options = {}) {
  const response = await fetch(`${BASE_URL}${endpoint}`, {
    ...options,
    headers: { "Content-Type": "application/json", "ngrok-skip-browser-warning": "true", ...(options.headers || {}) }
  });
  if (!response.ok) throw new Error(`HTTP ${response.status}`);
  return response;
}

function handleFileSelect(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    selectedImageBase64 = ev.target.result;
    document.getElementById('img-preview-target').src = selectedImageBase64;
    document.getElementById('image-preview-bar').style.display = 'block';
  };
  reader.readAsDataURL(file);
}

function clearSelectedImage() {
  selectedImageBase64 = null;
  document.getElementById('fileInput').value = "";
  document.getElementById('image-preview-bar').style.display = 'none';
}

/** 모델 리스트 생성 시 배지 감지 로직 고정 **/
async function openModelModal() {
  document.getElementById('modelModal').style.display = 'flex';
  const list = document.getElementById('modal-model-list');
  list.innerHTML = "모델 정보를 동기화 중...";
  try {
    const res = await apiFetch("/api/v1/models");
    const data = await res.json();
    list.innerHTML = "";
    data.models.forEach(m => {
      const isLoaded = m.loaded_instances?.length > 0;
      const isVis = m.capabilities?.vision === true;
      const isTool = m.capabilities?.trained_for_tool_use === true;
      const isRsn = m.key.toLowerCase().includes('r1') || m.key.toLowerCase().includes('reasoning');

      const div = document.createElement('div');
      div.className = `model-item ${currentModel === m.key ? 'active' : ''}`;
      div.onclick = () => switchModel(m.key);
      div.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <b>${m.display_name || m.id}</b>
          ${isLoaded ? '<span class="cap-badge badge-load">LOADED</span>' : ''}
        </div>
        <div class="badge-container">
          <span class="cap-badge">TXT</span>
          ${isVis ? '<span class="cap-badge badge-vis">VIS</span>' : ''}
          ${isTool ? '<span class="cap-badge badge-tool">TOOL</span>' : ''}
          ${isRsn ? '<span class="cap-badge badge-rsn">RSN</span>' : ''}
        </div>
        <div style="margin-top:5px; font-size:0.7rem; color:var(--text-muted)">${m.key}</div>
      `;
      list.appendChild(div);
    });
  } catch(e) { list.innerHTML = "API 연결 오류"; }
}

function closeModelModal() { document.getElementById('modelModal').style.display = 'none'; }

async function switchModel(key) {
  if (isSending) return;
  const list = document.getElementById('modal-model-list');
  list.innerHTML = "<div style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> 메모리 비우는 중...</div>";
  try {
    const statusRes = await apiFetch("/api/v1/models");
    const statusData = await statusRes.json();
    for (const model of statusData.models) {
      for (const inst of model.loaded_instances) {
        await apiFetch("/api/v1/models/unload", { method: "POST", body: JSON.stringify({ instance_id: inst.id }) });
      }
    }
    list.innerHTML = "<div style='text-align:center; padding:20px;'><i class='fas fa-spinner fa-spin'></i> 새 모델 임포트 중...</div>";
    await apiFetch("/api/v1/models/load", { method: "POST", body: JSON.stringify({ model: key }) });
    syncModelUI(key);
    closeModelModal();
    appendToUI("assistant", `✔️ **${key}** 모델이 준비되었습니다.`);
  } catch (e) { alert("교체 실패"); openModelModal(); }
}

/** 대시보드 상태 동기화 및 이미지 버튼 제어 **/
function syncModelUI(key) {
  currentModel = key;
  apiFetch("/api/v1/models").then(res => res.json()).then(data => {
    const m = data.models.find(mod => mod.key === key);
    const c = m?.capabilities || {};
    const isV = c.vision === true;
    const isR = key.toLowerCase().includes('r1') || key.toLowerCase().includes('reasoning');
    const isT = c.trained_for_tool_use === true;

    document.getElementById('active-model-info').innerHTML = `
      <b style="color:var(--highlight-color)">● ${key}</b>
      <div class="badge-container" style="margin-top:5px;">
        <span class="cap-badge">TXT</span>
        ${isV ? '<span class="cap-badge badge-vis">VIS</span>' : ''}
        ${isT ? '<span class="cap-badge badge-tool">TOOL</span>' : ''}
        ${isR ? '<span class="cap-badge badge-rsn">RSN</span>' : ''}
      </div>
    `;

    const imgBtn = document.getElementById('imgBtn');
    imgBtn.disabled = !isV;
    imgBtn.title = isV ? "이미지 첨부" : "Vision 미지원 모델";
    if (!isV) clearSelectedImage();
  });
}

function formatContent(text) {
  if (!text.includes("<think>")) return marked.parse(text);
  return text.replace(/<think>([\s\S]*?)<\/think>/g, (m, p1) => 
    `<div class="reasoning-box"><div class="reasoning-header"><i class="fas fa-brain"></i> Thinking Process</div>${marked.parse(p1)}</div>`
  ).replace(/<think>([\s\S]*)/g, (m, p1) => 
    `<div class="reasoning-box"><div class="reasoning-header"><i class="fas fa-spinner fa-spin"></i> Reasoning...</div>${marked.parse(p1)}</div>`
  );
}

async function sendMessage() {
  const text = chatInput.value.trim();
  if ((!text && !selectedImageBase64) || !currentModel || isSending) return;
  isSending = true; document.getElementById('sendBtn').disabled = true;
  const chat = chats.find(c => c.id === currentChatId);
  if (chat.messages.length === 0) { chat.title = text ? text.substring(0, 15) : "이미지 분석"; renderChatList(); }

  let userContent = selectedImageBase64 ? [
    { type: "text", text: text || "분석해줘." },
    { type: "image_url", image_url: { url: selectedImageBase64 } }
  ] : text;

  chat.messages.push({ role: "user", content: userContent });
  appendToUI("user", text || "[이미지]", selectedImageBase64);
  clearSelectedImage();
  const aiDiv = appendToUI("assistant", "...");
  let fullContent = "";
  
  try {
    const res = await apiFetch("/v1/chat/completions", { 
      method: "POST", body: JSON.stringify({ model: currentModel, messages: chat.messages, stream: true }) 
    });
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      const chunks = decoder.decode(value).split("\n");
      for (const chunk of chunks) {
        if (chunk.startsWith("data: ") && !chunk.includes("[DONE]")) {
          try {
            const data = JSON.parse(chunk.slice(6));
            fullContent += data.choices[0].delta.content || "";
            aiDiv.innerHTML = formatContent(fullContent);
            aiDiv.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
            document.getElementById('chatBox').scrollTop = document.getElementById('chatBox').scrollHeight;
          } catch (e) {}
        }
      }
    }
    chat.messages.push({ role: "assistant", content: fullContent });
    localStorage.setItem('lm_chats', JSON.stringify(chats));
  } catch (e) { aiDiv.innerText = "Error: " + e.message; }
  finally { isSending = false; document.getElementById('sendBtn').disabled = false; }
}

function createNewChat() {
  const id = Date.now().toString();
  chats.unshift({ id, title: "새 대화", messages: [] });
  localStorage.setItem('lm_chats', JSON.stringify(chats));
  selectChat(id);
}
function selectChat(id) { currentChatId = id; localStorage.setItem('lm_current_chat_id', id); renderChatBox(); renderChatList(); }
function renderChatList() {
  const list = document.getElementById('chat-list'); list.innerHTML = "";
  chats.forEach(c => {
    const div = document.createElement('div');
    div.className = `chat-item ${currentChatId === c.id ? 'active' : ''}`;
    div.onclick = () => selectChat(c.id);
    div.innerHTML = `<i class="far fa-comment"></i><span style="flex-grow:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${c.title}</span><i class="fas fa-times delete-chat" onclick="deleteChat('${c.id}', event)"></i>`;
    list.appendChild(div);
  });
}
function deleteChat(id, e) { e.stopPropagation(); chats = chats.filter(c => c.id !== id); if (currentChatId === id) currentChatId = chats.length ? chats[0].id : null; localStorage.setItem('lm_chats', JSON.stringify(chats)); renderChatList(); renderChatBox(); }
function renderChatBox() {
  const box = document.getElementById('chatBox'); box.innerHTML = "";
  const chat = chats.find(c => c.id === currentChatId);
  if (chat) chat.messages.forEach(m => {
    if (Array.isArray(m.content)) {
      const txt = m.content.find(i => i.type === 'text')?.text;
      const img = m.content.find(i => i.type === 'image_url')?.image_url.url;
      appendToUI(m.role, txt, img);
    } else appendToUI(m.role, m.content);
  });
}
function appendToUI(role, content, imgData = null) {
  const box = document.getElementById('chatBox');
  const div = document.createElement('div');
  div.className = `message ${role}`;
  if(role === 'user') {
    div.innerText = content;
    if(imgData) { const img = document.createElement('img'); img.src = imgData; img.className = 'msg-image'; div.appendChild(img); }
  } else div.innerHTML = formatContent(content);
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
  return div;
}

chatInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
chatInput.addEventListener('input', function() { this.style.height = '48px'; this.style.height = (this.scrollHeight) + 'px'; });

apiFetch("/api/v1/models").then(res => res.json()).then(data => {
  const loaded = data.models.find(m => m.loaded_instances.length > 0);
  if(loaded) syncModelUI(loaded.key);
}).catch(() => document.getElementById('active-model-info').innerText = "LM Studio 오프라인");

if (chats.length === 0) createNewChat(); else selectChat(currentChatId || chats[0].id);
</script>
</body>
</html>