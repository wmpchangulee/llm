<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LM Studio Pro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --bg: #0f1117; --sidebar-bg: #1a1d27; --card-bg: #252936;
      --accent: #3b82f6; --green: #10b981; --amber: #f59e0b; --purple: #8b5cf6;
      --text: #e2e8f0; --muted: #94a3b8; --border: #334155;
      --user-bg: #3b82f6; --ai-bg: #334155;
      --sidebar-w: 300px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100dvh; overflow: hidden; }

    /* â”€â”€ Sidebar â”€â”€ */
    #sidebar {
      width: var(--sidebar-w); background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      transition: transform .25s ease;
      position: relative; z-index: 10;
    }
    #sidebar.hidden { transform: translateX(-100%); position: fixed; height: 100dvh; }
    .sidebar-head { padding: 16px; border-bottom: 1px solid var(--border); }
    .model-box { background: var(--card-bg); border-radius: 10px; padding: 12px; margin-top: 10px; border: 1px solid var(--border); font-size: .83rem; }
    #chat-list-wrap { flex: 1; overflow-y: auto; padding: 8px; }
    .new-chat-btn { width: 100%; background: #ffffff12; color: var(--text); border: none; border-radius: 8px; padding: 11px; cursor: pointer; margin-bottom: 12px; font-size: .9rem; }
    .new-chat-btn:hover { background: #ffffff20; }
    .chat-item { padding: 11px 12px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 9px; font-size: .88rem; border: 1px solid transparent; margin-bottom: 4px; }
    .chat-item:hover { background: #ffffff08; }
    .chat-item.active { background: var(--card-bg); border-color: var(--accent); }
    .chat-item span { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .del-btn { opacity: 0; cursor: pointer; color: var(--muted); font-size: .8rem; }
    .chat-item:hover .del-btn { opacity: 1; }
    .del-btn:hover { color: #f87171; }

    /* â”€â”€ Overlay (mobile sidebar backdrop) â”€â”€ */
    #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.6); z-index: 9; }
    #overlay.show { display: block; }

    /* â”€â”€ Main â”€â”€ */
    #main { flex: 1; display: flex; flex-direction: column; min-width: 0; }

    /* â”€â”€ Top bar (mobile) â”€â”€ */
    #topbar {
      display: none; align-items: center; gap: 12px;
      padding: 12px 16px; border-bottom: 1px solid var(--border);
      background: var(--sidebar-bg);
    }
    #topbar button { background: none; border: none; color: var(--text); font-size: 1.1rem; cursor: pointer; }
    #topbar .model-tag { font-size: .78rem; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; }

    /* â”€â”€ Chat box â”€â”€ */
    #chatBox { flex: 1; padding: 24px 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 18px; }
    @media (min-width: 640px) { #chatBox { padding: 28px 32px; } }

    .message { max-width: min(85%, 720px); padding: 13px 16px; border-radius: 14px; line-height: 1.65; word-break: break-word; }
    .user { align-self: flex-end; background: var(--user-bg); border-bottom-right-radius: 3px; color: #fff; }
    .assistant { align-self: flex-start; background: var(--ai-bg); border-bottom-left-radius: 3px; }
    .msg-image { max-width: 100%; max-height: 260px; border-radius: 8px; margin-top: 10px; display: block; border: 1px solid #ffffff18; }

    /* â”€â”€ Reasoning box (collapsible) â”€â”€ */
    .reasoning-wrap { margin-bottom: 12px; }
    .reasoning-toggle {
      display: flex; align-items: center; gap: 7px;
      font-size: .75rem; font-weight: 700; color: var(--amber);
      background: rgba(245,158,11,.08); border: 1px solid rgba(245,158,11,.25);
      border-radius: 6px; cursor: pointer; padding: 6px 10px; width: 100%;
      letter-spacing: .03em;
    }
    .reasoning-toggle:hover { background: rgba(245,158,11,.14); }
    .reasoning-toggle .chevron { transition: transform .2s; font-size: .7rem; margin-left: auto; }
    .reasoning-toggle.open .chevron { transform: rotate(180deg); }
    .reasoning-body {
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(245,158,11,.2);
      border-top: none;
      border-radius: 0 0 6px 6px;
      padding: 0 14px;
      font-size: .88rem; color: var(--muted);
      max-height: 0; overflow: hidden;
      transition: max-height .35s ease, padding .35s ease;
    }
    .reasoning-body.open { max-height: 2000px; padding: 12px 14px; }
    .reasoning-body ol, .reasoning-body ul { padding-left: 1.5em; margin: 6px 0; }
    .reasoning-body li { margin: 3px 0; }
    .reasoning-body p { margin: 5px 0; }
    /* ì¼ë°˜ ë©”ì‹œì§€ ì˜ì—­ë„ ë™ì¼í•˜ê²Œ */
    .message ol, .message ul { padding-left: 1.5em; margin: 6px 0; }
    .message li { margin: 3px 0; }
    .message p { margin: 5px 0; }

    /* â”€â”€ Input area â”€â”€ */
    .input-wrap { padding: 12px 16px; border-top: 1px solid var(--border); background: var(--bg); }
    @media (min-width: 640px) { .input-wrap { padding: 14px 32px; } }
    #img-preview { display: none; position: relative; width: fit-content; margin-bottom: 8px; }
    #img-preview img { height: 70px; border-radius: 6px; border: 1px dashed var(--accent); }
    #img-preview button { position: absolute; top: -8px; right: -8px; background: #ef4444; color: #fff; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: .75rem; line-height: 20px; text-align: center; }
    .input-row { display: flex; gap: 8px; align-items: flex-end; max-width: 760px; margin: 0 auto; }
    #chatInput { flex: 1; background: var(--card-bg); border: 1px solid var(--border); color: var(--text); padding: 11px 14px; border-radius: 10px; outline: none; resize: none; min-height: 46px; max-height: 180px; font-family: inherit; font-size: .95rem; }
    #chatInput:focus { border-color: var(--accent); }
    .ibtn { background: var(--card-bg); border: 1px solid var(--border); color: var(--muted); width: 46px; height: 46px; border-radius: 9px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .ibtn:hover:not(:disabled) { color: var(--text); border-color: var(--accent); }
    .ibtn:disabled { opacity: .4; cursor: not-allowed; }
    #sendBtn { background: var(--accent); border: none; color: #fff; width: 46px; height: 46px; border-radius: 9px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    #sendBtn:disabled { opacity: .45; cursor: not-allowed; }

    /* â”€â”€ Badges â”€â”€ */
    .badges { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 6px; }
    .badge { font-size: 9px; padding: 2px 5px; border-radius: 3px; font-weight: 700; color: #fff; background: #555; text-transform: uppercase; }
    .bv { background: var(--accent); } .br { background: var(--amber); }
    .bt { background: var(--purple); } .bl { background: var(--green); }

    /* â”€â”€ Modal â”€â”€ */
    #modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.85); z-index: 100; justify-content: center; align-items: center; padding: 16px; }
    #modal.show { display: flex; }
    .modal-box { background: var(--sidebar-bg); padding: 22px; border-radius: 14px; width: 100%; max-width: 480px; max-height: 82dvh; overflow-y: auto; border: 1px solid var(--border); }
    .model-item { background: var(--card-bg); padding: 14px; border-radius: 10px; margin-bottom: 9px; border: 2px solid transparent; cursor: pointer; }
    .model-item:hover { border-color: #444; }
    .model-item.active { border-color: var(--green); }

    /* â”€â”€ Responsive: mobile sidebar â”€â”€ */
    @media (max-width: 639px) {
      #sidebar { position: fixed; height: 100dvh; transform: translateX(-100%); }
      #sidebar.show { transform: translateX(0); }
      #topbar { display: flex; }
      #main { width: 100%; }
    }
  </style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
  <div class="sidebar-head">
    <div style="font-size:.7rem;color:var(--muted);font-weight:700;letter-spacing:1px">SYSTEM STATUS</div>
    <div id="model-info" class="model-box">ì—°ê²° í™•ì¸ ì¤‘...</div>
    <button class="new-chat-btn" style="margin-top:10px" onclick="openModal()">ëª¨ë¸ ë¼ì´ë¸ŒëŸ¬ë¦¬</button>
  </div>
  <div id="chat-list-wrap">
    <button class="new-chat-btn" onclick="createNewChat()">ï¼‹ New Chat</button>
    <div id="chat-list"></div>
  </div>
</div>
<div id="overlay" onclick="closeSidebar()"></div>

<!-- Main -->
<div id="main">
  <!-- Mobile topbar -->
  <div id="topbar">
    <button onclick="openSidebar()"><i class="fas fa-bars"></i></button>
    <span class="model-tag" id="topbar-model">ëª¨ë¸ ë¯¸ì„ íƒ</span>
    <button onclick="openModal()" style="font-size:.85rem;color:var(--muted)"><i class="fas fa-layer-group"></i></button>
  </div>

  <div id="chatBox"></div>

  <div class="input-wrap">
    <div id="img-preview">
      <img id="img-thumb" src="">
      <button onclick="clearImg()">Ã—</button>
    </div>
    <div class="input-row">
      <button id="imgBtn" class="ibtn" onclick="document.getElementById('fileInput').click()" title="Vision ë¯¸ì§€ì›">
        <i class="fas fa-image"></i>
      </button>
      <input type="file" id="fileInput" hidden accept="image/*" onchange="handleFile(event)">
      <textarea id="chatInput" rows="1" placeholder="ë©”ì‹œì§€ ì…ë ¥... (Shift+Enter ì¤„ë°”ê¿ˆ)"></textarea>
      <button id="sendBtn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<!-- Model Modal -->
<div id="modal">
  <div class="modal-box">
    <h3 style="margin-bottom:16px">ëª¨ë¸ ë¼ì´ë¸ŒëŸ¬ë¦¬</h3>
    <div id="modal-list"></div>
    <button class="new-chat-btn" style="margin-top:10px" onclick="closeModal()">ë‹«ê¸°</button>
  </div>
</div>

<script>
const BASE_URL = "https://nonconferrable-tactlessly-jenell.ngrok-free.dev";
let currentModel = null, isSending = false, imgBase64 = null;
let chats = JSON.parse(localStorage.getItem('lm_chats') || '[]');
let currentChatId = localStorage.getItem('lm_current_chat_id');

marked.setOptions({ breaks: true, gfm: true });

// â”€â”€ API â”€â”€
async function apiFetch(ep, opts = {}) {
  const res = await fetch(BASE_URL + ep, {
    ...opts,
    headers: { "Content-Type": "application/json", "ngrok-skip-browser-warning": "true", ...(opts.headers || {}) }
  });
  if (!res.ok) { const t = await res.text().catch(() => ""); throw new Error(`HTTP ${res.status}: ${t}`); }
  return res;
}

// â”€â”€ Sidebar (mobile) â”€â”€
function openSidebar() {
  document.getElementById('sidebar').classList.add('show');
  document.getElementById('overlay').classList.add('show');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('show');
  document.getElementById('overlay').classList.remove('show');
}

// â”€â”€ Image â”€â”€
function handleFile(e) {
  const f = e.target.files[0]; if (!f) return;
  const r = new FileReader();
  r.onload = ev => {
    imgBase64 = ev.target.result;
    document.getElementById('img-thumb').src = imgBase64;
    document.getElementById('img-preview').style.display = 'block';
  };
  r.readAsDataURL(f);
}
function clearImg() {
  imgBase64 = null;
  document.getElementById('fileInput').value = "";
  document.getElementById('img-preview').style.display = 'none';
}

// â”€â”€ Modal â”€â”€
async function openModal() {
  document.getElementById('modal').classList.add('show');
  const list = document.getElementById('modal-list');
  list.innerHTML = "<div style='text-align:center;padding:20px'><i class='fas fa-circle-notch fa-spin'></i></div>";
  try {
    const data = await apiFetch("/api/v1/models").then(r => r.json());
    list.innerHTML = "";
    data.models.forEach(m => {
      const loaded = m.loaded_instances?.length > 0;
      const isV = m.capabilities?.vision === true;
      const isT = m.capabilities?.trained_for_tool_use === true;
      const isR = m.key.toLowerCase().includes('r1') || m.key.toLowerCase().includes('reasoning');
      const d = document.createElement('div');
      d.className = `model-item ${currentModel === m.key ? 'active' : ''}`;
      d.onclick = () => switchModel(m.key);
      d.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <b>${m.display_name || m.id}</b>
          ${loaded ? '<span class="badge bl">LOADED</span>' : ''}
        </div>
        <div class="badges">
          <span class="badge">TXT</span>
          ${isV ? '<span class="badge bv">VIS</span>' : ''}
          ${isT ? '<span class="badge bt">TOOL</span>' : ''}
          ${isR ? '<span class="badge br">RSN</span>' : ''}
        </div>
        <div style="margin-top:5px;font-size:.73rem;color:var(--muted)">${m.key}</div>`;
      list.appendChild(d);
    });
  } catch(e) { list.innerHTML = `<div style='color:#f87171'>ì—°ê²° ì‹¤íŒ¨: ${e.message}</div>`; }
}
function closeModal() { document.getElementById('modal').classList.remove('show'); }

async function switchModel(key) {
  if (isSending) return;
  const list = document.getElementById('modal-list');
  list.innerHTML = "<div style='text-align:center;padding:20px'><i class='fas fa-sync fa-spin'></i> êµì²´ ì¤‘...</div>";
  try {
    const d = await apiFetch("/api/v1/models").then(r => r.json());
    for (const m of d.models)
      for (const inst of (m.loaded_instances || []))
        await apiFetch("/api/v1/models/unload", { method: "POST", body: JSON.stringify({ instance_id: inst.id }) });
    await apiFetch("/api/v1/models/load", { method: "POST", body: JSON.stringify({ model: key }) });
    syncModelUI(key); closeModal();
    appendMsg("assistant", `### ğŸ†• ëª¨ë¸ êµì²´ ì™„ë£Œ\n**${key}** ì¤€ë¹„ëìŠµë‹ˆë‹¤.`);
  } catch(e) { alert("ì˜¤ë¥˜: " + e.message); openModal(); }
}

function syncModelUI(key) {
  currentModel = key;
  document.getElementById('topbar-model').textContent = key;
  apiFetch("/api/v1/models").then(r => r.json()).then(d => {
    const m = d.models.find(x => x.key === key);
    const c = m?.capabilities || {};
    const isV = c.vision === true, isT = c.trained_for_tool_use === true;
    const isR = key.toLowerCase().includes('r1') || key.toLowerCase().includes('reasoning');
    document.getElementById('model-info').innerHTML = `
      <b style="color:var(--green)">â— ${key}</b>
      <div class="badges" style="margin-top:6px">
        <span class="badge">TXT</span>
        ${isV ? '<span class="badge bv">VIS</span>' : ''}
        ${isT ? '<span class="badge bt">TOOL</span>' : ''}
        ${isR ? '<span class="badge br">RSN</span>' : ''}
      </div>`;
    const ib = document.getElementById('imgBtn');
    ib.disabled = !isV;
    ib.title = isV ? "ì´ë¯¸ì§€ ì²¨ë¶€" : "Vision ë¯¸ì§€ì›";
    if (!isV) clearImg();
  });
}

// â”€â”€ Render â”€â”€
// ì¶”ë¡ ì°½ ì—¬ë‹«ì´: í´ë¦­í•˜ë©´ reasoning-body / toggle ë²„íŠ¼ í´ë˜ìŠ¤ í† ê¸€
function makeReasoningBlock(reasoningHtml, streaming) {
  const id = "rsn_" + Date.now() + Math.random().toString(36).slice(2);
  const icon = streaming ? "fas fa-spinner fa-spin" : "fas fa-brain";
  return `
    <div class="reasoning-wrap">
      <button class="reasoning-toggle" onclick="toggleReasoning('${id}', this)">
        <i class="${icon}" id="${id}_icon"></i>
        <span>Thinking Process</span>
        <i class="fas fa-chevron-down chevron"></i>
      </button>
      <div class="reasoning-body" id="${id}">${reasoningHtml}</div>
    </div>`;
}

function toggleReasoning(id, btn) {
  const body = document.getElementById(id);
  body.classList.toggle('open');
  btn.classList.toggle('open');
}

function renderBlocks(text, reasoning, streaming = false) {
  let html = "";
  if (reasoning) html += makeReasoningBlock(marked.parse(reasoning), streaming);
  if (text) html += marked.parse(text);
  return html || "<i class='fas fa-circle-notch fa-spin'></i>";
}

// â”€â”€ Auto-scroll: ìœ ì €ê°€ ìœ„ë¡œ ìŠ¤í¬ë¡¤í•˜ë©´ ìë™ ìŠ¤í¬ë¡¤ ë©ˆì¶¤ â”€â”€
let userScrolled = false;
const chatBox = document.getElementById('chatBox');
chatBox.addEventListener('scroll', () => {
  const atBottom = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 60;
  userScrolled = !atBottom;
});
function scrollIfNeeded() {
  if (!userScrolled) chatBox.scrollTop = chatBox.scrollHeight;
}

// â”€â”€ Send â”€â”€
function buildInput(text, img) {
  if (img) return [
    { type: "text", content: text || "ì´ ì´ë¯¸ì§€ë¥¼ ì„¤ëª…í•´ì¤˜." },
    { type: "image", data_url: img }
  ];
  return text;
}

async function sendMessage() {
  const text = chatInput.value.trim();
  if ((!text && !imgBase64) || !currentModel || isSending) return;

  isSending = true;
  document.getElementById('sendBtn').disabled = true;
  chatInput.value = "";
  chatInput.style.height = '46px';
  userScrolled = false; // ìƒˆ ë©”ì‹œì§€ ë³´ë‚¼ ë• ìë™ ìŠ¤í¬ë¡¤ ì¬í™œì„±

  const chat = chats.find(c => c.id === currentChatId);
  if (chat.messages.length === 0) { chat.title = text ? text.slice(0, 18) : "ì´ë¯¸ì§€"; renderChatList(); }

  appendMsg("user", text || "[ì´ë¯¸ì§€]", imgBase64);

  const userContent = imgBase64
    ? [{ type: "text", text: text || "ì´ ì´ë¯¸ì§€ë¥¼ ì„¤ëª…í•´ì¤˜." }, { type: "image_url", image_url: { url: imgBase64 } }]
    : text;

  const aiDiv = appendMsg("assistant", "");
  let fullText = "", fullReasoning = "", newRespId = null;

  // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ reasoning-body ì—…ë°ì´íŠ¸ìš© ID
  let rsnBodyId = null;

  try {
    const body = { model: currentModel, input: buildInput(text, imgBase64), stream: true, temperature: 0.7, store: true };
    if (chat.lastResponseId) body.previous_response_id = chat.lastResponseId;

    const res = await apiFetch("/api/v1/chat", { method: "POST", body: JSON.stringify(body) });
    clearImg();

    const reader = res.body.getReader();
    const dec = new TextDecoder();
    let buf = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += dec.decode(value, { stream: true });
      const lines = buf.split("\n");
      buf = lines.pop();

      for (const line of lines) {
        const t = line.trim();
        if (!t || t.startsWith("event:") || !t.startsWith("data:")) continue;
        const raw = t.slice(5).trim();
        if (!raw || raw === "[DONE]") continue;
        try {
          const ev = JSON.parse(raw);
          switch (ev.type) {
            case "reasoning.start":
              // reasoning ë¸”ë¡ ë¯¸ë¦¬ ìƒì„± (ì ‘íŒ ìƒíƒœ)
              rsnBodyId = "rsn_" + Date.now();
              aiDiv.innerHTML = `
                <div class="reasoning-wrap">
                  <button class="reasoning-toggle" onclick="toggleReasoning('${rsnBodyId}', this)">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Thinking Process</span>
                    <i class="fas fa-chevron-down chevron"></i>
                  </button>
                  <div class="reasoning-body" id="${rsnBodyId}"></div>
                </div>`;
              break;

            case "reasoning.delta":
              fullReasoning += ev.content || "";
              if (rsnBodyId) {
                const bd = document.getElementById(rsnBodyId);
                if (bd) bd.innerHTML = marked.parse(fullReasoning);
              }
              break;

            case "reasoning.end":
              // ìŠ¤í”¼ë„ˆ â†’ ë‡Œ ì•„ì´ì½˜ìœ¼ë¡œ êµì²´
              if (rsnBodyId) {
                const toggleBtn = aiDiv.querySelector('.reasoning-toggle');
                if (toggleBtn) toggleBtn.querySelector('i:first-child').className = 'fas fa-brain';
              }
              break;

            case "message.delta":
              fullText += ev.content || "";
              // ê¸°ì¡´ reasoning ë¸”ë¡ ë³´ì¡´ + í…ìŠ¤íŠ¸ ì¶”ê°€
              const textPart = document.getElementById('text_part_' + rsnBodyId);
              if (rsnBodyId) {
                let tp = aiDiv.querySelector('.msg-text-part');
                if (!tp) { tp = document.createElement('div'); tp.className = 'msg-text-part'; aiDiv.appendChild(tp); }
                tp.innerHTML = marked.parse(fullText);
              } else {
                aiDiv.innerHTML = marked.parse(fullText);
              }
              break;

            case "chat.end":
              newRespId = ev.result?.response_id || null;
              break;
          }
          aiDiv.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
          scrollIfNeeded();
        } catch(e) { console.warn("[SSE parse fail]", line); }
      }
    }

    // ì™„ë£Œ í›„ ìµœì¢… ë Œë” (hljs ì¬ì ìš©)
    aiDiv.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
    if (newRespId) chat.lastResponseId = newRespId;

    chat.messages.push({ role: "user", content: userContent });
    chat.messages.push({ role: "assistant", content: fullReasoning ? `<think>${fullReasoning}</think>\n${fullText}` : fullText });
    localStorage.setItem('lm_chats', JSON.stringify(chats));

    console.group(`%c[DEBUG] ${currentModel}`, "color:#10b981;font-weight:bold");
    console.log("response_id:", newRespId);
    console.log("reasoning:", fullReasoning);
    console.log("text:", fullText);
    console.groupEnd();

  } catch(e) {
    aiDiv.innerHTML = `<span style="color:#f87171">ì˜¤ë¥˜: ${e.message}</span>`;
    console.error(e);
  } finally {
    isSending = false;
    document.getElementById('sendBtn').disabled = false;
  }
}

// â”€â”€ Chat management â”€â”€
function createNewChat() {
  const id = Date.now().toString();
  chats.unshift({ id, title: "ìƒˆ ëŒ€í™”", messages: [], lastResponseId: null });
  localStorage.setItem('lm_chats', JSON.stringify(chats));
  selectChat(id);
  closeSidebar();
}
function selectChat(id) {
  currentChatId = id;
  localStorage.setItem('lm_current_chat_id', id);
  renderChatBox(); renderChatList();
}
function renderChatList() {
  const list = document.getElementById('chat-list'); list.innerHTML = "";
  chats.forEach(c => {
    const d = document.createElement('div');
    d.className = `chat-item ${currentChatId === c.id ? 'active' : ''}`;
    d.onclick = () => { selectChat(c.id); closeSidebar(); };
    d.innerHTML = `<i class="far fa-comment" style="opacity:.5"></i><span>${c.title}</span><i class="fas fa-times del-btn" onclick="delChat('${c.id}',event)"></i>`;
    list.appendChild(d);
  });
}
function delChat(id, e) {
  e.stopPropagation();
  chats = chats.filter(c => c.id !== id);
  if (currentChatId === id) currentChatId = chats.length ? chats[0].id : null;
  localStorage.setItem('lm_chats', JSON.stringify(chats));
  renderChatList(); renderChatBox();
}
function renderChatBox() {
  chatBox.innerHTML = "";
  const chat = chats.find(c => c.id === currentChatId);
  if (!chat) return;
  chat.messages.forEach(m => {
    if (Array.isArray(m.content)) {
      const txt = m.content.find(i => i.type === 'text')?.text;
      const img = m.content.find(i => i.type === 'image_url')?.image_url?.url;
      appendMsg(m.role, txt, img);
    } else appendMsg(m.role, m.content);
  });
}

function appendMsg(role, content, imgData = null) {
  const div = document.createElement('div');
  div.className = `message ${role}`;
  if (role === 'user') {
    div.innerText = content;
    if (imgData) { const img = document.createElement('img'); img.src = imgData; img.className = 'msg-image'; div.appendChild(img); }
  } else {
    if (!content) {
      // ë¹ˆ ìƒíƒœ (ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ ì „)
    } else if (content.includes('<think>')) {
      const m = content.match(/<think>([\s\S]*?)<\/think>/);
      const txt = content.replace(/<think>[\s\S]*?<\/think>\n?/, '').trim();
      div.innerHTML = renderBlocks(txt, m?.[1], false);
    } else {
      div.innerHTML = marked.parse(content);
    }
    div.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
  }
  chatBox.appendChild(div);
  scrollIfNeeded();
  return div;
}

// â”€â”€ Input auto-resize â”€â”€
chatInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    // IME ì¡°í•© ì¤‘(í•œê¸€ ë“±)ì´ë©´ ë¬´ì‹œ â€” ì¡°í•© ì™„ë£Œ í›„ keydownì´ ë‹¤ì‹œ ë°œìƒí•¨
    if (e.isComposing || e.keyCode === 229) return;
    sendMessage();
  }
});
chatInput.addEventListener('input', function() {
  this.style.height = '46px';
  this.style.height = Math.min(this.scrollHeight, 180) + 'px';
});

// â”€â”€ Init â”€â”€
apiFetch("/api/v1/models").then(r => r.json()).then(d => {
  const loaded = d.models.find(m => m.loaded_instances?.length > 0);
  if (loaded) syncModelUI(loaded.key);
}).catch(() => { document.getElementById('model-info').innerHTML = "<span style='color:#f87171'>â— ì˜¤í”„ë¼ì¸</span>"; });

if (chats.length === 0) createNewChat();
else selectChat(currentChatId || chats[0].id);
</script>
</body>
</html>